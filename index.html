<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DiscordChats ‚Äî Wolfpac</title>
  <style>
    :root {
      --bg: #202225;
      --bg-2: #2f3136;
      --bg-3: #36393f;
      --text: #e5e7eb;
      --muted: #a3a6aa;
      --accent: #ed4245; /* default red for names with no role color */
    }
    * { box-sizing: border-box; }
    body { margin:0; background: var(--bg-3); color: var(--text); font: 14px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .layout { display:grid; grid-template-columns: 260px 1fr; height: 100vh; }
    .left {
      background: var(--bg-2);
      border-right: 1px solid #1f2024;
      display:flex; flex-direction:column;
    }
    .guild {
      padding: 14px 12px; border-bottom:1px solid #1f2024;
      display:flex; align-items:center; gap:10px; background: var(--bg-2);
    }
    .guild img { height:28px; border-radius:4px; }
    .guild h1 { margin:0; font-size:16px; font-weight:700; letter-spacing:.3px; display:flex; align-items:center; gap:8px; }
    .cat { padding: 10px 12px; font-weight:700; color:#cdd0d4; letter-spacing:.3px; }
    .calendar { padding: 8px 12px; overflow:auto; }
    .dates { display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; }
    .date-btn {
      background:#202226; color:#d5d8dc; border:1px solid #1b1c20; border-radius:6px; padding:8px 6px; cursor:pointer; text-align:center;
    }
    .date-btn:hover { background:#26282d; }
    .date-btn.active { outline:2px solid #7289da; }

    .center { display:flex; flex-direction:column; height:100vh; }
    .channel-header {
      padding: 12px 16px; background: var(--bg-2); border-bottom:1px solid #1f2024; display:flex; align-items:center; gap:10px;
      font-weight:700;
    }

    .feed { padding: 14px 16px; overflow:auto; }
    .msg { display:grid; grid-template-columns: 44px 1fr; gap:12px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.04); }
    .avatar { width:44px; height:44px; border-radius:50%; object-fit:cover; background:#111; }
    .header { display:flex; align-items:center; gap:8px; }
    .name { font-weight:700; }
    .gradient {
      background: var(--accent);
      -webkit-background-clip: text; background-clip:text; color: transparent;
    }
    .time { color: var(--muted); font-size:12px; }
    .wolf { margin-left:2px; opacity:.9; }
    .content { white-space: pre-wrap; margin-top:4px; }
    .att { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
    .att img { max-width: 420px; border-radius:8px; border:1px solid rgba(255,255,255,.08); }

    /* utility */
    .muted { color: var(--muted); }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="left">
      <div class="guild">
        <img src="wolfpac.gif" alt="Wolfpac" />
        <h1>Wolfpac</h1>
      </div>
      <div class="cat">üê∫„ÉªChats</div>
      <div class="calendar">
        <div id="dates" class="dates"></div>
      </div>
    </aside>

    <main class="center">
      <div class="channel-header"># chat-archive <span class="muted" id="count"></span></div>
      <div id="feed" class="feed"></div>
    </main>
  </div>

  <script>
    const datesEl = document.getElementById('dates');
    const feedEl  = document.getElementById('feed');
    const countEl = document.getElementById('count');

    let activeDate = null;
    let loading = false;
    let nextOffset = 0;

    function nameSpan(display, c1, c2) {
      const span = document.createElement('span');
      span.className = 'name gradient';
      if (c1 && c2) {
        span.style.backgroundImage = `linear-gradient(90deg, ${c1}, ${c2})`;
      } else if (c1) {
        span.style.backgroundImage = `linear-gradient(90deg, ${c1}, ${c1})`;
      } else {
        // default red
        span.style.backgroundImage = `linear-gradient(90deg, #ed4245, #ed4245)`;
      }
      span.textContent = display ?? 'Unknown';
      return span;
    }

    function msgRow(m) {
      const row = document.createElement('div');
      row.className = 'msg';
      const img = document.createElement('img');
      img.className = 'avatar';
      img.src = m.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png';
      row.appendChild(img);

      const right = document.createElement('div');
      const head = document.createElement('div'); head.className = 'header';
      head.appendChild(nameSpan(m.display_name, m.role_color_1, m.role_color_2));

      const wolf = document.createElement('span'); wolf.className = 'wolf'; wolf.textContent = 'üê∫';
      head.appendChild(wolf);

      const time = document.createElement('span'); time.className = 'time'; time.textContent = m.time;
      head.appendChild(time);

      right.appendChild(head);

      if (m.content) {
        const c = document.createElement('div');
        c.className = 'content';
        c.textContent = m.content;
        right.appendChild(c);
      }

      if (m.attachments && m.attachments.length) {
        const wrap = document.createElement('div'); wrap.className = 'att';
        m.attachments.forEach(a => {
          if (a.url && (a.content_type || '').startsWith('image/') || /\.(png|jpe?g|gif|webp|bmp|tiff)$/i.test(a.filename)) {
            const im = document.createElement('img'); im.src = a.url; im.alt = a.filename;
            wrap.appendChild(im);
          }
        });
        right.appendChild(wrap);
      }

      row.appendChild(right);
      return row;
    }

    async function fetchDates() {
      const r = await fetch('/api/dates');
      const data = await r.json();
      datesEl.innerHTML = '';
      data.forEach((d, idx) => {
        const btn = document.createElement('button');
        btn.className = 'date-btn';
        btn.textContent = d.date;
        btn.onclick = () => selectDate(d.date, btn);
        datesEl.appendChild(btn);
        if (idx === 0) {
          // auto select oldest
          setTimeout(() => btn.click(), 0);
        }
      });
    }

    function clearActive() {
      [...datesEl.children].forEach(b => b.classList.remove('active'));
    }

    async function selectDate(date, btnEl) {
      if (loading) return;
      activeDate = date; nextOffset = 0;
      clearActive(); btnEl.classList.add('active');
      feedEl.innerHTML = '';
      countEl.textContent = `‚Äî ${date}`;
      await loadMore();
    }

    async function loadMore() {
      if (loading || !activeDate) return;
      loading = true;
      const r = await fetch(`/api/messages?date=${encodeURIComponent(activeDate)}&offset=${nextOffset}&limit=500`);
      const data = await r.json();
      data.items.forEach(m => feedEl.appendChild(msgRow(m)));
      nextOffset = data.next_offset;
      loading = false;
    }

    // infinite scroll
    feedEl.addEventListener('scroll', () => {
      if (feedEl.scrollTop + feedEl.clientHeight >= feedEl.scrollHeight - 200) {
        loadMore();
      }
    });

    fetchDates();
  </script>
</body>
</html>
